#!/bin/bash

# Get image name from the command line
# Check if image name is set on the first argument (positional parameter)
if [ 3 -le $# ]; then
    echo "Usage: $0 <image-name> [optional: threshold]"
    exit 1
fi
image_name=$1

# Check if severity threshold is set on the second argument
if [ $# -eq 2 ]; then
    severity_threshold=$2
    # Check if severity threshold is valid
    if [ "$severity_threshold" != "low" ] && [ "$severity_threshold" != "medium" ] && [ "$severity_threshold" != "high" ] && [ "$severity_threshold" != "critical" ]; then
        echo "Invalid severity threshold: $severity_threshold"
        exit 1
    fi
else
    severity_threshold="critical"
fi


return_code=0

# This script is used to test the image for vulnerabilities and fail on specific vulnerabilities.

# Create a temporary directory
tmp_dir=$(mktemp -d -t grype-XXXXXXXXXX)

# Change to the temporary directory
pushd $tmp_dir

# Download the latest version of Grype
curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh -o install.sh
if [ $? -ne 0 ]; then
    echo "Failed to download Grype"
    popd
    rm -rf $tmp_dir
    exit 1
fi

# Install Grype
sh install.sh -b .
if [ $? -ne 0 ]; then
    echo "Failed to install Grype"
    popd
    rm -rf $tmp_dir
    exit 1
fi

# Run Grype against the image
./grype --fail-on critical $1 
return_code=$?

# Remove the temporary directory
popd
rm -rf $tmp_dir

# Exit with the return code from Grype
exit $return_code
